"""
보고서 생성 설정 파일
===================

이 파일은 보고서 생성에 필요한 모든 설정값을 정의합니다.
- 파일 경로
- 예측 타겟 지표 목록
- 등급 기준
- 지표별 방향성 (높을수록 좋은지, 낮을수록 좋은지)
- 모델 신뢰도 기준
- 표시 형식

다른 모듈에서 이 설정값들을 import해서 사용합니다.
"""
from pathlib import Path

# =============================================================================
# 경로 설정
# =============================================================================
# ai-server 기본 경로 (app/report/config.py 기준)
BASE_PATH = Path(__file__).parent.parent.parent

# 전처리된 데이터가 저장된 경로
DATA_PATH = BASE_PATH / 'data' / 'processed'

# 학습된 XGBoost 모델이 저장된 경로
MODEL_PATH = BASE_PATH / 'ml_models'

# 주요 데이터 파일들
DATASET_FILE = DATA_PATH / '03_dataset_final.csv'           # 최종 학습/서빙용 데이터
FEATURE_COLS_FILE = DATA_PATH / '03_feature_cols.json'      # 고정된 피처 목록 (376개)
THRESHOLDS_FILE = DATA_PATH / '03_thresholds.csv'           # 윈저라이징 임계값

# =============================================================================
# 예측 타겟 (13개 재무지표)
# =============================================================================
# 카테고리별로 그룹화된 예측 대상 지표들
# 각 지표는 다음 분기 값을 예측함 (예: ROA → ROA_next 예측)
TARGET_METRICS = {
    # 수익성 지표 (3개): 기업이 얼마나 효율적으로 이익을 창출하는지
    '수익성': ['ROA', 'ROE', '매출액영업이익률'],

    # 안정성 지표 (3개): 재무 구조가 얼마나 안정적인지
    '안정성': ['부채비율', '자기자본비율', '자본잠식률'],

    # 차입금 지표 (1개): 단기 차입 의존도
    '차입금': ['단기차입금비율'],

    # 유동성 지표 (3개): 단기 지급 능력
    '유동성': ['유동비율', '당좌비율', '유동부채비율'],

    # 현금흐름 지표 (3개): 실제 현금 창출 능력
    '현금흐름': ['CFO_자산비율', 'CFO_매출액비율', 'CFO증감률'],
}

# 전체 타겟 리스트 (평탄화) - 13개
# 딕셔너리를 풀어서 하나의 리스트로 만듦
ALL_TARGETS = [m for metrics in TARGET_METRICS.values() for m in metrics]

# =============================================================================
# 등급 기준 (백분위 기반)
# =============================================================================
# 업종 내 상위 몇 %에 해당하면 어떤 등급인지 정의
# 예: 상위 10% 이내면 A+, 상위 25% 이내면 A, ...
GRADE_THRESHOLDS = {
    'A+': 10,   # 상위 10% (매우 우수)
    'A': 25,    # 상위 25% (우수)
    'B+': 40,   # 상위 40% (양호)
    'B': 60,    # 상위 60% (보통)
    'C': 80,    # 상위 80% (주의)
    'F': 100,   # 하위 20% (위험)
}

# 등급별 점수 (종합 등급 계산용)
# 여러 지표의 등급을 평균내서 종합 등급을 산출할 때 사용
GRADE_SCORES = {
    'A+': 6,
    'A': 5,
    'B+': 4,
    'B': 3,
    'C': 2,
    'F': 1,
}

# =============================================================================
# 지표별 방향성
# =============================================================================
# 'higher': 값이 높을수록 좋음 (예: ROA, 유동비율)
# 'lower': 값이 낮을수록 좋음 (예: 부채비율, 자본잠식률)
#
# 이 방향성은 두 가지 용도로 사용됨:
# 1. 백분위 계산 시 순위 방향 결정
# 2. 예측 결과 해석 시 개선/악화 판단
METRIC_DIRECTION = {
    # 수익성 - 모두 높을수록 좋음
    'ROA': 'higher',                    # 총자산이익률
    'ROE': 'higher',                    # 자기자본이익률
    '매출액영업이익률': 'higher',         # 영업이익/매출액

    # 안정성 - 부채 관련은 낮을수록, 자본 관련은 높을수록 좋음
    '부채비율': 'lower',                 # 부채/자기자본 (낮을수록 안정)
    '자기자본비율': 'higher',             # 자기자본/총자산 (높을수록 안정)
    '자본잠식률': 'lower',               # 낮을수록(음수일수록) 좋음. 양수면 잠식, 음수면 건전

    # 차입금 - 낮을수록 좋음
    '단기차입금비율': 'lower',            # 단기차입금/총자산

    # 유동성 - 유동/당좌는 높을수록, 유동부채비율은 낮을수록 좋음
    '유동비율': 'higher',                # 유동자산/유동부채 (100% 이상 권장)
    '당좌비율': 'higher',                # 당좌자산/유동부채 (재고 제외)
    '유동부채비율': 'lower',              # 유동부채/총부채

    # 현금흐름 - 모두 높을수록 좋음
    'CFO_자산비율': 'higher',            # 영업현금흐름/총자산
    'CFO_매출액비율': 'higher',           # 영업현금흐름/매출액
    'CFO증감률': 'higher',               # 영업현금흐름 증감률
}

# =============================================================================
# 모델 신뢰도 기준 (R² 기반)
# =============================================================================
# 예측 모델의 R² 값에 따라 신뢰도 등급 부여
# R²: 모델이 실제값의 변동을 얼마나 설명하는지 (0~1, 높을수록 좋음)
MODEL_CONFIDENCE = {
    'high': 0.7,      # R² >= 0.7 → 높은 신뢰도
    'medium': 0.4,    # 0.4 <= R² < 0.7 → 중간 신뢰도
    'low': 0.0,       # R² < 0.4 → 낮은 신뢰도 (참고용)
}

# 각 지표별 모델 R² (Best 모델 - 튜닝 후)
# 지표별로 Base vs Tuned 중 더 나은 모델 선택
MODEL_R2 = {
    'ROA': 0.4187,              # Tuned - 중간 신뢰도
    'ROE': 0.3564,              # Tuned - 낮은 신뢰도
    '매출액영업이익률': 0.6664,   # Tuned - 중간 신뢰도
    '부채비율': 0.8197,          # Tuned - 높은 신뢰도
    '자기자본비율': 0.9430,       # Tuned - 높은 신뢰도
    '자본잠식률': 0.9897,         # Tuned - 높은 신뢰도
    '단기차입금비율': 0.7897,     # Base - 높은 신뢰도
    '유동비율': 0.8720,          # Tuned - 높은 신뢰도
    '당좌비율': 0.8723,          # Tuned - 높은 신뢰도
    '유동부채비율': 0.8015,       # Tuned - 높은 신뢰도
    'CFO_자산비율': 0.2987,      # Tuned - 낮은 신뢰도
    'CFO_매출액비율': 0.5254,    # Tuned - 중간 신뢰도
    'CFO증감률': 0.2973,         # Base - 낮은 신뢰도
}

# =============================================================================
# 메타 컬럼 (피처로 사용하지 않는 컬럼들)
# =============================================================================
META_COLS = ['기업코드', '기업명', '시장구분', '업종코드', '업종명', '년도', '분기']

# =============================================================================
# 표시 형식
# =============================================================================
# 각 지표를 문자열로 포맷팅할 때 사용하는 형식
# 모든 지표가 % 단위이므로 소수점 2자리까지 표시
METRIC_FORMAT = {
    'ROA': '{:.2f}%',
    'ROE': '{:.2f}%',
    '매출액영업이익률': '{:.2f}%',
    '부채비율': '{:.2f}%',
    '자기자본비율': '{:.2f}%',
    '자본잠식률': '{:.2f}%',
    '단기차입금비율': '{:.2f}%',
    '유동비율': '{:.2f}%',
    '당좌비율': '{:.2f}%',
    '유동부채비율': '{:.2f}%',
    'CFO_자산비율': '{:.2f}%',
    'CFO_매출액비율': '{:.2f}%',
    'CFO증감률': '{:.2f}%',
}

# 지표별 한글 설명 (보고서에 표시용)
METRIC_DESCRIPTION = {
    'ROA': '총자산이익률 - 자산 대비 순이익 비율. 기업이 보유한 자산을 얼마나 효율적으로 활용해 이익을 창출하는지 측정',
    'ROE': '자기자본이익률 - 자기자본 대비 순이익 비율. 주주가 투자한 자본으로 얼마나 이익을 내는지 측정',
    '매출액영업이익률': '매출액 대비 영업이익 비율. 본업에서 얼마나 효율적으로 이익을 내는지 측정',
    '부채비율': '자기자본 대비 부채 비율. 낮을수록 재무구조가 안정적',
    '자기자본비율': '총자산 대비 자기자본 비율. 높을수록 재무구조가 안정적',
    '자본잠식률': '자본금 대비 결손금 비율. 0보다 크면 잠식 상태로 위험 신호',
    '단기차입금비율': '총자산 대비 단기차입금 비율. 높으면 단기 상환 부담 증가',
    '유동비율': '유동부채 대비 유동자산 비율. 100% 이상이면 단기 지급능력 양호',
    '당좌비율': '유동부채 대비 당좌자산 비율. 재고자산 제외한 더 엄격한 유동성 지표',
    '유동부채비율': '총부채 대비 유동부채 비율. 높으면 단기 부채 비중이 높음',
    'CFO_자산비율': '총자산 대비 영업현금흐름 비율. 자산 대비 실제 현금 창출력',
    'CFO_매출액비율': '매출액 대비 영업현금흐름 비율. 매출이 실제 현금으로 전환되는 비율',
    'CFO증감률': '영업현금흐름 전분기 대비 증감률. 현금 창출력의 변화 추이',
}

# =============================================================================
# SHAP 피쳐 설명 매핑 (XAI 해석용)
# =============================================================================
# AI 모델이 예측에 사용하는 피쳐들의 비즈니스적 의미 설명
FEATURE_DESCRIPTION = {
    # 원본 재무비율
    'ROA': '총자산이익률 (수익성)',
    'ROE': '자기자본이익률 (수익성)',
    '매출액영업이익률': '영업이익률 (수익성)',
    '부채비율': '부채/자기자본 비율 (안정성)',
    '자기자본비율': '자기자본/총자산 비율 (안정성)',
    '자본잠식률': '자본잠식 정도 (안정성)',
    '단기차입금비율': '단기차입금 의존도 (차입금)',
    '유동비율': '유동자산/유동부채 (유동성)',
    '당좌비율': '당좌자산/유동부채 (유동성)',
    '유동부채비율': '유동부채/총부채 (유동성)',
    'CFO_자산비율': '영업현금흐름/총자산 (현금흐름)',
    'CFO_매출액비율': '영업현금흐름/매출액 (현금흐름)',
    'CFO증감률': '영업현금흐름 변화율 (현금흐름)',
    '이익잉여금비율': '이익잉여금/총자산 (안정성)',

    # Lag 피쳐 (과거 분기 값)
    '_lag1': '전분기 값',
    '_lag2': '2분기 전 값',
    '_lag3': '3분기 전 값',

    # 시계열 파생 피쳐
    '_MA4': '4분기 이동평균',
    '_STD4': '4분기 변동성(표준편차)',
    '_YoY': '전년동기비 변화',
    '_MOM': '전분기비 변화',

    # 업종상대 피쳐
    '_업종상대': '업종 평균 대비 차이',

    # 재무제표 항목
    'BS_자산총계': '총자산 규모',
    'BS_부채총계': '총부채 규모',
    'BS_자본총계': '총자본 규모',
    'BS_유동자산': '유동자산 규모',
    'BS_유동부채': '유동부채 규모',
    'BS_비유동부채': '비유동부채 규모',
    'BS_무형자산': '무형자산 규모',
    'PL_매출액': '매출액 규모',
    'PL_영업이익': '영업이익 규모',
    'PL_당기순이익': '당기순이익 규모',
    'CF_영업현금흐름': '영업현금흐름 규모',

    # 분기 정보
    '분기코드': '분기 계절성 요인',
}

def get_feature_description(feature_name: str) -> str:
    """
    SHAP 피쳐명을 비즈니스적 설명으로 변환

    Args:
        feature_name: 피쳐명 (예: 'ROA_lag1', '부채비율_업종상대', 'BS_자산총계_MA4')

    Returns:
        str: 비즈니스적 설명
    """
    # 직접 매칭
    if feature_name in FEATURE_DESCRIPTION:
        return FEATURE_DESCRIPTION[feature_name]

    # 접미사 패턴 매칭
    for suffix, suffix_desc in [
        ('_lag1', ' 전분기 값'),
        ('_lag2', ' 2분기 전 값'),
        ('_lag3', ' 3분기 전 값'),
        ('_MA4', ' 4분기 이동평균'),
        ('_STD4', ' 4분기 변동성'),
        ('_YoY', ' 전년동기비 변화'),
        ('_MOM', ' 전분기비 변화'),
        ('_업종상대', ' (업종 대비)'),
    ]:
        if feature_name.endswith(suffix):
            base_name = feature_name[:-len(suffix)]
            base_desc = FEATURE_DESCRIPTION.get(base_name, base_name)
            return f'{base_desc}{suffix_desc}'

    # 재무제표 항목 패턴 매칭
    if feature_name.startswith('BS_'):
        item = feature_name.replace('BS_', '재무상태표 - ')
        return item
    if feature_name.startswith('PL_'):
        item = feature_name.replace('PL_', '손익계산서 - ')
        return item
    if feature_name.startswith('CF_'):
        item = feature_name.replace('CF_', '현금흐름표 - ')
        return item

    # 기본값: 원본 피쳐명 반환
    return feature_name
